---
- hosts: xsnippet
  tasks:
    - name: ensure Python 2 is installed
      raw: test -e /usr/bin/python || (apt -y update && apt install -y python-minimal)
      become: true
  gather_facts: false

- hosts: xsnippet
  become: true
  tasks:
    - name: update apt cache (if needed)
      apt: update_cache=yes cache_valid_time=3600

    - name: install essential packages
      apt: "name={{ item }} state=latest"
      with_items:
        - apt-transport-https
        - ca-certificates

    - name: add Docker gpg key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: add Docker packages repo
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
      register: newrepo

    - name: update apt cache (if needed)
      apt: update_cache=yes
      when: newrepo.changed

    - name: install the latest Docker
      apt: name=docker-ce state=latest

    - name: configure Docker to send container logs to journald
      template:
        src: configs/docker.conf.j2
        dest: "/etc/docker/daemon.json"
        mode: 0644
        owner: root
        group: root
      register: newdockerconf

    - name: restart Docker (if needed)
      service:
        name: docker
        state: restarted
      when: newdockerconf.changed

    - name: initialize Docker Swarm
      shell: "docker swarm init --advertise-addr 127.0.0.1 || docker stack ls"
      register: init_result
      changed_when: "'This node is already part of a swarm' not in init_result.stderr"

    - name: create xsnippet user
      user:
        name: xsnippet
        createhome: yes
        append: true
        groups: docker

- hosts: xsnippet
  vars:
    # nginx will be configured to serve both API and SPA on the same port (80) under different server names
    xsnippet_api_server_name: api.xsnippet.org
    xsnippet_spa_server_name: xsnippet.org
    # versions of API and SPA to be used
    xsnippet_api_image: xsnippet/xsnippet-api:v1.0.0
    xsnippet_web_assets: https://github.com/xsnippet/xsnippet-web/releases/download/v1.0.0/xsnippet_web-v1.0.0.tar.gz
    xsnippet_web_backend_image: xsnippet/xsnippet-web-backend:v1.0.0
    # paths to SSL certifactes on the target machine
    xsnippet_api_https_redirect: false  # do not force HTTPS redirect for now to allow for local development
    xsnippet_api_ssl_cert: /home/xsnippet/xsnippet_api_ssl.cert
    xsnippet_api_ssl_key: /home/xsnippet/xsnippet_api_ssl.key
    xsnippet_spa_https_redirect: true
    xsnippet_spa_ssl_cert: /home/xsnippet/xsnippet_spa_ssl.cert
    xsnippet_spa_ssl_key: /home/xsnippet/xsnippet_spa_ssl.key
  become: true
  become_user: xsnippet
  tasks:
    - stat:
        path: "{{ xsnippet_api_ssl_cert }}"
      register: xsnippet_api_ssl_cert_file

    - stat:
        path: "{{ xsnippet_api_ssl_key }}"
      register: xsnippet_api_ssl_key_file

    - name: serve xsnippet-api over HTTPS, if a certifacte/key pair has been provided
      set_fact:
        xsnippet_api_https: "{{ xsnippet_api_ssl_cert_file.stat.exists and xsnippet_api_ssl_key_file.stat.exists }}"

    - stat:
        path: "{{ xsnippet_spa_ssl_cert }}"
      register: xsnippet_spa_ssl_cert_file

    - stat:
        path: "{{ xsnippet_spa_ssl_key }}"
      register: xsnippet_spa_ssl_key_file

    - name: serve xsnippet-web (and xsnippet-web-backend) over HTTPS, if a certifacte/key pair has been provided
      set_fact:
        xsnippet_spa_https: "{{ xsnippet_spa_ssl_cert_file.stat.exists and xsnippet_spa_ssl_key_file.stat.exists }}"

    - file:
        path: "/home/xsnippet/xsnippet-web"
        state: directory

    - name: prepare xsnippet-web assets
      unarchive:
        src: "{{ xsnippet_web_assets }}"
        dest: "/home/xsnippet/xsnippet-web"
        remote_src: yes

    - name: prepare the config file
      template:
        src: configs/xsnippet-api.conf.j2
        dest: "/home/xsnippet/xsnippet-api.conf"
        mode: 0600
        owner: xsnippet
        group: xsnippet

    - name: prepare the webserver config for API
      template:
        src:  configs/xsnippet-webserver-api.conf.j2
        dest: "/home/xsnippet/xsnippet-webserver-api.conf"
        mode: 0600
        owner: xsnippet
        group: xsnippet

    - name: prepare the webserver config for SPA
      template:
        src:  configs/xsnippet-webserver-spa.conf.j2
        dest: "/home/xsnippet/xsnippet-webserver-spa.conf"
        mode: 0600
        owner: xsnippet
        group: xsnippet

    - name: prepare the Docker stack config
      template:
        src: docker/stack.yml.j2
        dest: "/home/xsnippet/stack.yml"
        mode: 0600
        owner: xsnippet
        group: xsnippet

    # The only reason we need to remove the stack first is the fact, that configs in Docker Swarm
    # are "immutable" and are not updated when the corresponding stacks are updated. See issue
    # https://github.com/moby/moby/issues/35048 for details.
    - name: ensure there is no Docker Swarm stack
      command: "docker stack rm xsnippet"
      args:
        chdir: "/home/xsnippet"

    - name: (re-)create the xsnippet Docker Swarm stack
      command: "docker stack deploy -c stack.yml xsnippet"
      args:
        chdir: "/home/xsnippet"
      register: result
      # stack removal may still be in progress and stand in a way - do a few retries if necessary
      until: result.rc == 0
      retries: 3
      delay: 10
